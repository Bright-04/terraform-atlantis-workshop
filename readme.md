# Terraform Atlantis Workshop

## Overview

This workshop demonstrates **Environment Provisioning Automation** using Terraform and Atlantis with a focus on approval workflows, cost controls, and monitoring integration. The project is designed to work with both LocalStack (for cost-free development) and real AWS infrastructure.

### Workshop Objectives
- Implement automated environment provisioning with Terraform
- Set up approval workflows using Atlantis
- Integrate cost controls and monitoring
- Establish compliance validation and rollback procedures
- Create comprehensive operational documentation

## Technologies Used

### Core Infrastructure
- **Terraform (v1.0+)** - Infrastructure as Code
- **AWS Provider (~5.0)** - Cloud resources management
- **LocalStack** - Local AWS cloud stack for development
- **Docker & Docker Compose** - Container orchestration

### Development Tools
- **PowerShell** - Automation scripts
- **Git** - Version control
- **VS Code** - Development environment

### Planned Integration
- **Atlantis** - GitOps workflow automation
- **CloudWatch** - Monitoring and alerting
- **AWS Cost Explorer** - Cost management
- **S3** - Terraform state backend

## Current Status

### ‚úÖ Completed
- [x] **LocalStack Development Environment**
  - **LIVE LocalStack Infrastructure**: Successfully deployed to LocalStack simulation
  - Docker Compose configuration with LocalStack and Atlantis
  - VPC with public/private subnets (10.0.0.0/16) - *Resource IDs generated by LocalStack*
  - Internet Gateway and route tables - *Resource IDs generated by LocalStack*
  - Security groups for web servers (HTTP, HTTPS, SSH) - *Resource IDs generated by LocalStack*
  - EC2 instance running Amazon Linux 2 - *Resource IDs generated by LocalStack*
  - Simulated Public IP and DNS endpoints (LocalStack simulation)
  - Complete variable definitions and validation
  - Output values for resource references

- [x] **S3 Bucket Implementation**
  - S3 bucket successfully deployed - **terraform-atlantis-workshop-workshop-bucket**
  - Bucket ARN: **arn:aws:s3:::terraform-atlantis-workshop-workshop-bucket**
  - Versioning enabled and configured
  - Server-side encryption with AES256
  - Integrated into main configuration and deployed on LocalStack

- [x] **Cost-Free Development Setup**
  - LocalStack provides realistic AWS simulation without costs
  - Support for EC2, S3, RDS, IAM, CloudWatch, Lambda, API Gateway
  - Realistic resource IDs and ARNs for testing
  - Local development environment ready and tested

- [x] **Atlantis Integration**
  - Complete Atlantis server configuration in Docker Compose
  - GitHub integration setup with webhook support
  - Approval workflow definitions in atlantis.yaml
  - Environment-based configuration with .env support
  - PowerShell script for GitHub integration setup
  - Terraform v1.6.0 integration with LocalStack

- [x] **Dual Environment Support**
  - LocalStack configuration for cost-free development (currently active)
  - AWS production configuration available in backup files
  - Environment-specific provider configurations
  - Flexible deployment and destruction scripts

- [x] **Project Structure & Automation**
  - Organized terraform configurations
  - Backup configurations for different environments
  - PowerShell deployment and destroy scripts
  - GitHub integration automation script
  - Comprehensive documentation and examples

### üéØ Current Live Infrastructure
**Environment**: LocalStack Development (localhost:4566)
- **VPC**: vpc-xxxxxxxxxxxxxxxx (10.0.0.0/16) - *Example: vpc-6d00b9d6ac7738846*
- **Public Subnet**: subnet-xxxxxxxxxxxxxxxx (10.0.1.0/24) - *Example: subnet-26905880e7999b1f9*
- **Private Subnet**: subnet-xxxxxxxxxxxxxxxx (10.0.2.0/24) - *Example: subnet-8debece313b2ddc1a*
- **EC2 Instance**: i-xxxxxxxxxxxxxxxx (t3.micro) - *Example: i-b7aa46897c205c4e6*
- **Simulated Website URL**: http://ec2-xx-xxx-xx-xxx.compute-1.amazonaws.com (LocalStack)
- **S3 Bucket**: terraform-atlantis-workshop-workshop-bucket
- **Security Group**: sg-xxxxxxxxxxxxxxxx - *Example: sg-abcf2898efe6d3089*

**‚ö†Ô∏è LocalStack Simulation Notes**:
- All resources are running on LocalStack with realistic AWS-like resource IDs
- The EC2 instance is simulated - no actual web server is running
- Network connectivity is simulated - external URLs won't be accessible
- S3 bucket operations work through LocalStack endpoint (localhost:4566)
- Perfect for development, testing, and cost-free experimentation

### üöß In Progress
- [ ] **LocalStack Infrastructure Validation**
  - Verify LocalStack EC2 instance simulation
  - Test S3 bucket functionality in LocalStack
  - Validate security group configurations
  - Test networking and routing within LocalStack

### üìã Planned
- [ ] **AWS Production Deployment**
  - Switch from LocalStack to real AWS
  - Configure real AWS credentials
  - Deploy to production AWS environment
  - Set up cost monitoring and alerts

- [ ] **Monitoring Setup**
  - CloudWatch metrics and alarms
  - Cost monitoring dashboard
  - Infrastructure health checks

- [ ] **Advanced Approval Workflows**
  - Multi-stage approval process
  - Automated compliance checks
  - Branch-based deployment strategies

- [ ] **Cost Controls**
  - Budget alerts and limits
  - Resource tagging strategy
  - Cost optimization recommendations

- [ ] **Compliance & Security**
  - Security group auditing
  - Compliance validation rules
  - Automated security scanning

- [ ] **Rollback Procedures**
  - Automated rollback mechanisms
  - State backup and recovery
  - Disaster recovery procedures

## Project Structure

```
terraform-atlantis-workshop/
‚îú‚îÄ‚îÄ atlantis.yaml                   # Atlantis workflow configuration
‚îú‚îÄ‚îÄ docker-compose.yml              # LocalStack and Atlantis containers
‚îú‚îÄ‚îÄ setup-github-integration.ps1    # GitHub integration setup script
‚îú‚îÄ‚îÄ .env.example                    # Environment variables template
‚îú‚îÄ‚îÄ workshop_info.md                # Workshop requirements and objectives
‚îú‚îÄ‚îÄ dev.md                          # Development notes and guidelines
‚îú‚îÄ‚îÄ ENVIRONMENT_SETUP.md            # Environment setup instructions
‚îú‚îÄ‚îÄ TESTING.md                      # Testing procedures
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                     # Current Terraform configuration (LocalStack)
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf                # Variable definitions
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf                  # Output values
‚îÇ   ‚îú‚îÄ‚îÄ versions.tf                 # Provider requirements
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars            # Variable values (configured)
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars.example    # Example variables
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfstate           # Current state (deployed)
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfstate.backup    # State backup
‚îÇ   ‚îú‚îÄ‚îÄ deploy.ps1                  # Deployment script
‚îÇ   ‚îú‚îÄ‚îÄ destroy.ps1                 # Cleanup script
‚îÇ   ‚îî‚îÄ‚îÄ backup/
‚îÇ       ‚îú‚îÄ‚îÄ main-aws.tf             # AWS production configuration
‚îÇ       ‚îú‚îÄ‚îÄ main-localstack.tf      # LocalStack with S3 bucket
‚îÇ       ‚îú‚îÄ‚îÄ main.tf                 # Generic backup configuration
‚îÇ       ‚îî‚îÄ‚îÄ versions.tf             # Provider version backups
‚îú‚îÄ‚îÄ atlantis/
‚îÇ   ‚îú‚îÄ‚îÄ atlantis.db                 # Atlantis database file
‚îÇ   ‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ terraform1.6.0         # Terraform binary
‚îÇ   ‚îî‚îÄ‚îÄ plugin-cache/               # Terraform plugin cache
‚îú‚îÄ‚îÄ docs/                           # Documentation (placeholder)
‚îú‚îÄ‚îÄ monitoring/                     # Monitoring configuration (placeholder)
‚îî‚îÄ‚îÄ localstack-data/                # LocalStack persistence data
```

## Getting Started

### Prerequisites
- Docker Desktop installed and running
- PowerShell (Windows) or equivalent shell
- Git for version control
- AWS CLI (for future production deployment)
- GitHub account (for Atlantis integration)

### Current Infrastructure Status

**‚úÖ LIVE LocalStack INFRASTRUCTURE DEPLOYED**

The infrastructure is currently running on **LocalStack** (AWS simulation) with the following resources:
- **LocalStack Endpoint**: http://localhost:4566
- **Simulated Website**: http://ec2-xx-xxx-xx-xxx.compute-1.amazonaws.com (LocalStack)
- **Instance ID**: i-xxxxxxxxxxxxxxxx *(Example: i-b7aa46897c205c4e6)*
- **VPC**: vpc-xxxxxxxxxxxxxxxx *(Example: vpc-6d00b9d6ac7738846)*
- **S3 Bucket**: terraform-atlantis-workshop-workshop-bucket

### Manage Current LocalStack Infrastructure

1. **View Current Resources**
   ```powershell
   cd terraform
   terraform output
   terraform show
   ```

2. **Check LocalStack Resources**
   ```powershell
   # Set LocalStack environment
   $env:AWS_ACCESS_KEY_ID="test"
   $env:AWS_SECRET_ACCESS_KEY="test"
   $env:AWS_DEFAULT_REGION="us-east-1"
   
   # Check EC2 instances
   aws --endpoint-url=http://localhost:4566 ec2 describe-instances
   
   # Check S3 buckets
   aws --endpoint-url=http://localhost:4566 s3 ls
   ```

3. **Check LocalStack Status**
   ```powershell
   # Check if LocalStack is running
   docker-compose ps
   
   # Check LocalStack health
   curl "http://localhost:4566/_localstack/health"
   ```

### Deploy to LocalStack

Your infrastructure is already deployed! But to recreate it:

1. **Start LocalStack**
   ```powershell
   # Start LocalStack service
   docker-compose up localstack -d
   
   # Wait for LocalStack to be ready
   docker-compose logs localstack
   ```

2. **Deploy Infrastructure**
   ```powershell
   cd terraform
   .\deploy.ps1
   ```

### Future: Deploy to Real AWS

When ready for production AWS deployment:

1. **Configure AWS Credentials**
   ```powershell
   aws configure
   ```

2. **Switch to AWS Configuration**
   ```powershell
   # Use the AWS production configuration
   Copy-Item backup/main-aws.tf main.tf -Force
   ```

3. **Deploy to Real AWS**
   ```powershell
   terraform init
   terraform plan
   terraform apply
   ```

### Alternative: Fresh LocalStack Setup

To set up a new LocalStack environment:

1. **Clone and Navigate**
   ```powershell
   git clone <repository-url>
   cd terraform-atlantis-workshop
   ```

2. **Start LocalStack**
   ```powershell
   # Start LocalStack for local development
   docker-compose up localstack -d
   
   # Check LocalStack is running
   docker-compose ps
   ```

3. **Deploy to LocalStack** (current configuration is already set)
   ```powershell
   cd terraform
   
   # Configure LocalStack environment
   $env:AWS_ACCESS_KEY_ID="test"
   $env:AWS_SECRET_ACCESS_KEY="test"
   $env:AWS_DEFAULT_REGION="us-east-1"
   
   # Deploy infrastructure
   .\deploy.ps1
   ```

4. **Verify LocalStack Deployment**
   ```powershell
   # Check LocalStack resources
   aws --endpoint-url=http://localhost:4566 ec2 describe-instances
   aws --endpoint-url=http://localhost:4566 s3 ls
   ```

### Atlantis GitOps Workflow (Optional)

To enable GitOps workflow with Atlantis:

1. **Configure GitHub Integration**
   ```powershell
   # Run the setup script to configure GitHub integration
   .\setup-github-integration.ps1
   ```

2. **Start Atlantis**
   ```powershell
   # Start Atlantis service
   docker-compose up atlantis -d
   ```

3. **Access Atlantis UI**
   ```
   http://localhost:4141
   ```

### GitOps Workflow with Atlantis

Once GitHub integration is configured:

1. **Create a Pull Request** with infrastructure changes
2. **Atlantis automatically runs** `terraform plan`
3. **Review the plan** in the PR comments
4. **Approve the PR** following your approval workflow
5. **Comment `atlantis apply`** to apply changes
6. **Atlantis applies** the infrastructure changes

### Manual Deployment to Real AWS (Future)

When ready to deploy to real AWS instead of LocalStack:

1. **Configure AWS Credentials**
   ```powershell
   aws configure
   ```

2. **Switch to AWS Configuration**
   ```powershell
   Copy-Item backup/main-aws.tf main.tf -Force
   ```

3. **Deploy to Real AWS**
   ```powershell
   terraform init
   terraform plan
   terraform apply
   ```

### Configuration

The project uses the following default configuration:
- **VPC CIDR**: 10.0.0.0/16
- **Public Subnet**: 10.0.1.0/24
- **Private Subnet**: 10.0.2.0/24
- **Instance Type**: t3.micro
- **Region**: us-east-1

Customize these values in `terraform.tfvars` or through environment variables.

## Key Features

### GitOps Workflow with Atlantis
- **Pull Request-Based Infrastructure Changes**: All changes through PR workflow
- **Automated Plan Generation**: Atlantis automatically runs `terraform plan`
- **Approval Requirements**: Configurable approval workflows before apply
- **GitHub Integration**: Seamless integration with GitHub webhooks
- **Audit Trail**: Complete history of infrastructure changes

### Cost-Effective Development
- **LocalStack Integration**: Develop and test without AWS costs
- **Container-Based Setup**: Quick environment provisioning
- **Resource Optimization**: Efficient resource allocation
- **Environment Isolation**: Separate development and production

### Infrastructure as Code
- **Terraform Best Practices**: Modular, reusable configurations
- **Version Control**: All infrastructure changes tracked
- **Automated Deployment**: PowerShell and Atlantis-based deployment
- **State Management**: Proper state file handling and backup

### Security & Compliance
- **Security Groups**: Properly configured network access
- **Resource Tagging**: Consistent labeling strategy
- **Environment Separation**: Isolated development/production
- **Approval Workflows**: Controlled infrastructure changes

### Operational Excellence
- **Comprehensive Documentation**: Clear setup and usage guides
- **Automated Scripts**: PowerShell automation for common tasks
- **Container Orchestration**: Docker Compose for service management
- **Monitoring Ready**: Structured for monitoring integration

## Next Steps

1. **LocalStack Infrastructure Validation**
   - ‚úÖ S3 bucket integration completed with versioning
   - Test LocalStack web server simulation functionality
   - Verify S3 bucket operations in LocalStack
   - Validate security group rules and networking

2. **Transition to Production AWS** (when ready)
   - Configure real AWS credentials
   - Switch to AWS production configuration
   - Deploy to real AWS environment
   - Set up cost monitoring and budget alerts

3. **Enhance Atlantis Workflows**
   - Configure multi-environment workflows (LocalStack ‚Üí AWS)
   - Add policy checks and validation
   - Implement custom approval requirements
   - Set up branch-based deployment strategies

4. **Advanced LocalStack Testing**
   - Test complex networking scenarios
   - Implement automated testing with terratest
   - Validate infrastructure resilience
   - Test disaster recovery procedures

5. **Production Readiness**
   - Add encryption for S3 and EBS volumes
   - Implement IAM roles and policies
   - Configure monitoring and alerting
   - Set up compliance validation rules

6. **Monitoring & Observability** (for AWS)
   - Deploy CloudWatch dashboards
   - Configure application monitoring
   - Set up log aggregation and analysis
   - Implement performance monitoring

## Troubleshooting

### Common Issues

**LocalStack Issues:**
- **LocalStack not starting**: Check Docker Desktop is running
- **Port conflicts**: Ensure ports 4566 and 4510-4559 are available
- **Service timeouts**: Wait for LocalStack health check to pass

**Atlantis Issues:**
- **Atlantis not accessible**: Check port 4141 is available
- **GitHub webhook errors**: Verify .env configuration and webhook URL
- **Permission errors**: Ensure GitHub token has proper permissions

**Terraform Issues:**
- **State lock errors**: Check if terraform processes are running
- **Provider errors**: Verify LocalStack is running and accessible
- **Resource conflicts**: Check for existing resources in LocalStack

### Service Management

**Check Service Status:**
```powershell
# Check all services
docker-compose ps

# Check specific service logs
docker-compose logs localstack
docker-compose logs atlantis
```

**Restart Services:**
```powershell
# Restart specific service
docker-compose restart localstack
docker-compose restart atlantis

# Restart all services
docker-compose restart
```

### Cleanup
```powershell
# Destroy infrastructure
cd terraform
.\destroy.ps1

# Stop all services
docker-compose down

# Remove volumes and networks (complete cleanup)
docker-compose down -v --remove-orphans
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test with LocalStack
5. Submit a pull request

## Author

**Nguyen Nhat Quang (Bright-04)**
- Email: cbl.nguyennhatquang2809@gmail.com
- Repository: terraform-atlantis-workshop
- Program: First Cloud Journey 2025, Amazon Web Service Vietnam
- Focus: Environment Provisioning Automation with Terraform and Atlantis

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

*This project is part of a workshop series focusing on infrastructure automation, GitOps workflows, and cloud cost optimization.*
