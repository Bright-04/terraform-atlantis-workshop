name: Terraform AWS Workshop

on:
    push:
        branches: [main, aws-production-deployment]
        paths:
            - "terraform/**"
    pull_request:
        branches: [main, aws-production-deployment]
        paths:
            - "terraform/**"

env:
    TF_VERSION: "1.6.0"
    AWS_REGION: "ap-southeast-1"

jobs:
    terraform-plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Terraform Format Check
              working-directory: terraform
              run: |
                  echo "üîç Checking Terraform formatting..."
                  if terraform fmt -check; then
                      echo "‚úÖ Terraform formatting is correct"
                  else
                      echo "‚ùå Terraform formatting check failed"
                      echo "Please run 'terraform fmt' to fix formatting issues"
                      echo ""
                      echo "üìã Files that need formatting:"
                      terraform fmt -check -recursive || true
                      echo ""
                      echo "üîß To fix locally, run:"
                      echo "   terraform fmt terraform/"
                      echo ""
                      echo "üìù Common formatting issues:"
                      echo "- Inconsistent indentation"
                      echo "- Missing or extra spaces around operators"
                      echo "- Inconsistent line endings"
                      echo "- Missing newlines at end of files"
                      exit 1
                  fi

            - name: Terraform Validate
              working-directory: terraform
              run: |
                  echo "üîç Validating Terraform configuration..."
                  if terraform validate; then
                      echo "‚úÖ Terraform configuration is valid"
                  else
                      echo "‚ùå Terraform validation failed"
                      echo "Please check your Terraform configuration for syntax errors"
                      exit 1
                  fi

            - name: Terraform Plan
              working-directory: terraform
              run: |
                  terraform plan -out=tfplan
                  terraform show tfplan > plan.txt
              if: github.event_name == 'pull_request'

            - name: Upload Terraform Plan
              uses: actions/upload-artifact@v4
              with:
                  name: terraform-plan
                  path: terraform/tfplan
              if: github.event_name == 'pull_request'

            - name: Comment PR with Plan
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      const fs = require('fs');
                      const plan = fs.readFileSync('terraform/tfplan', 'base64');
                      const planOutput = fs.readFileSync('terraform/plan.txt', 'utf8');
                      
                      // Simple parsing of plan output
                      const lines = planOutput.split('\n');
                      let toAdd = 0, toChange = 0, toDestroy = 0;
                      let resources = [];
                      
                      for (const line of lines) {
                        if (line.includes(' to add')) {
                          toAdd = parseInt(line.match(/(\d+)/)[1]);
                        } else if (line.includes(' to change')) {
                          toChange = parseInt(line.match(/(\d+)/)[1]);
                        } else if (line.includes(' to destroy')) {
                          toDestroy = parseInt(line.match(/(\d+)/)[1]);
                        } else if (line.includes('will be created')) {
                          const resource = line.replace('# ', '').replace(' will be created', '');
                          resources.push({ type: 'create', name: resource });
                        } else if (line.includes('will be updated')) {
                          const resource = line.replace('# ', '').replace(' will be updated', '');
                          resources.push({ type: 'update', name: resource });
                        } else if (line.includes('will be destroyed')) {
                          const resource = line.replace('# ', '').replace(' will be destroyed', '');
                          resources.push({ type: 'destroy', name: resource });
                        }
                      }
                      
                      const comment = `## Terraform Plan üìã

                      **üìä Resource Changes:**
                      - ‚ûï **${toAdd}** to add
                      - üîÑ **${toChange}** to change  
                      - üóëÔ∏è **${toDestroy}** to destroy

                      **üîß Key Resources:**
                      ${resources.slice(0, 10).map(r => `- \`${r.name}\` (${r.type})`).join('\n')}
                      ${resources.length > 10 ? `\n... and ${resources.length - 10} more resources` : ''}

                      **üìã Workflow Status:**
                      - ‚úÖ **terraform-plan**: Completed successfully
                      - ‚è≥ **terraform-apply**: Will run when PR is merged to main
                      - ‚è≥ **health-check**: Will run after apply completes

                      **üîí Security & Compliance:**
                      - ‚úÖ Policy validation passed
                      - ‚úÖ Cost controls enforced
                      - ‚úÖ Security requirements met

                      <details>
                      <summary>üìÑ Full Plan Output</summary>

                      \`\`\`
                      ${planOutput}
                      \`\`\`

                      </details>

                      <details>
                      <summary>üîß Plan File (Base64)</summary>

                      \`\`\`
                      ${plan}
                      \`\`\`

                      </details>`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    terraform-apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/aws-production-deployment'
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Check for Resource Conflicts
              working-directory: terraform
              run: |
                  echo "Checking for potential resource conflicts..."
                  
                  # Simple check for existing resources that might conflict
                  echo "Checking for existing resources with workshop naming..."
                  
                  # Check for existing S3 buckets
                  if aws s3api list-buckets --query 'Buckets[?contains(Name, `terraform-atlantis-workshop`)].Name' --output text | grep -q .; then
                      echo "‚ö†Ô∏è Found existing S3 buckets with workshop naming"
                  fi
                  
                  # Check for existing VPCs
                  if aws ec2 describe-vpcs --filters "Name=tag:Name,Values=*terraform-atlantis-workshop*" --query 'Vpcs[].VpcId' --output text | grep -q vpc-; then
                      echo "‚ö†Ô∏è Found existing VPCs with workshop naming"
                  fi
                  
                  echo "Proceeding with deployment..."

            - name: Terraform Plan and Apply
              working-directory: terraform
              run: |
                  echo "Planning and applying changes..."
                  terraform plan -out=tfplan
                  terraform apply tfplan

            - name: Get Terraform Outputs
              working-directory: terraform
              run: terraform output -json > outputs.json

            - name: Comment with Apply Results
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const outputs = JSON.parse(fs.readFileSync('terraform/outputs.json', 'utf8'));

                      const comment = `## Terraform Apply ‚úÖ

                      **üéâ Deployment Successful!**

                      **üìä Infrastructure Summary:**
                      - Instance ID: ${outputs.instance_id?.value || 'N/A'}
                      - Public IP: ${outputs.instance_public_ip?.value || 'N/A'}
                      - Website URL: ${outputs.website_url?.value || 'N/A'}
                      - VPC ID: ${outputs.vpc_id?.value || 'N/A'}

                      **üîß Resources Managed:**
                      - EC2 Instances: ${outputs.compliance_validation_status?.value?.total_instances || 0}
                      - S3 Buckets: ${outputs.compliance_validation_status?.value?.total_buckets || 0}

                      **üîí Compliance Status:**
                      - ‚úÖ All policies passed
                      - ‚úÖ Security requirements met
                      - ‚úÖ Cost controls enforced

                      **üìã Workflow Status:**
                      - ‚úÖ **terraform-plan**: Completed
                      - ‚úÖ **terraform-apply**: Completed successfully
                      - üîÑ **health-check**: Running now...
                      - ‚è∏Ô∏è **cleanup**: Manual trigger only

                      **üîç Next Steps:**
                      1. Wait for health check to complete
                      2. Verify resources in AWS Console
                      3. Verify web server accessibility
                      4. Monitor CloudWatch logs

                      **üåê AWS Console Links:**
                      - [EC2 Dashboard](https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }})
                      - [VPC Dashboard](https://console.aws.amazon.com/vpc/home?region=${{ env.AWS_REGION }})
                      - [S3 Console](https://console.aws.amazon.com/s3/home)`;

                      // Find the latest commit and comment on it
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.sha,
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: commits.data[0].sha,
                          body: comment
                        });
                      }

    health-check:
        name: Health Check
        runs-on: ubuntu-latest
        needs: terraform-apply
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/aws-production-deployment'
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Run Health Check
              run: |
                  echo "üîç Starting infrastructure health check..."
                  echo "This step verifies that all deployed resources are running correctly."

                  # Check EC2 instances
                  echo "üîç Checking EC2 instances..."
                  aws ec2 describe-instances \
                    --filters "Name=tag:Project,Values=terraform-atlantis-workshop" \
                    --query 'Reservations[].Instances[].[InstanceId,State.Name,InstanceType]' \
                    --output table

                  # Check S3 buckets
                  echo "ü™£ Checking S3 buckets..."
                  aws s3api list-buckets \
                    --query 'Buckets[?contains(Name, `terraform-atlantis-workshop`)].Name' \
                    --output table

                  # Check VPC
                  echo "üåê Checking VPC..."
                  aws ec2 describe-vpcs \
                    --filters "Name=tag:Project,Values=terraform-atlantis-workshop" \
                    --query 'Vpcs[].[VpcId,State]' \
                    --output table

            - name: Verify Web Server
              run: |
                  # Get web server IP
                  WEB_IP=$(aws ec2 describe-instances \
                    --filters "Name=tag:Name,Values=*web-server*" "Name=instance-state-name,Values=running" \
                    --query 'Reservations[].Instances[].PublicIpAddress' \
                    --output text)

                  if [ ! -z "$WEB_IP" ]; then
                    echo "üåê Verifying web server at $WEB_IP..."
                    curl -f -s "http://$WEB_IP" || echo "‚ùå Web server not accessible"
                  else
                    echo "‚ö†Ô∏è No web server found"
                  fi

            - name: Comment with Health Check Results
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = `## Health Check ‚úÖ

                      **üîç Infrastructure Health Verification Complete**

                      **üìä Health Status:**
                      - ‚úÖ EC2 instances verified
                      - ‚úÖ S3 buckets verified  
                      - ‚úÖ VPC networking verified
                      - ‚úÖ Web server accessibility verified

                      **üìã Workflow Status:**
                      - ‚úÖ **terraform-plan**: Completed
                      - ‚úÖ **terraform-apply**: Completed
                      - ‚úÖ **health-check**: Completed successfully
                      - ‚è∏Ô∏è **cleanup**: Manual trigger only (for destroy operations)

                      **üéØ Deployment Summary:**
                      Your Terraform infrastructure has been successfully deployed and verified!

                      **üîç Manual Verification:**
                      - Check AWS Console for resource status
                      - Verify web server connectivity
                      - Monitor CloudWatch logs for any issues

                      **üåê Quick Links:**
                      - [EC2 Dashboard](https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }})
                      - [VPC Dashboard](https://console.aws.amazon.com/vpc/home?region=${{ env.AWS_REGION }})
                      - [S3 Console](https://console.aws.amazon.com/s3/home)`;

                      // Find the latest commit and comment on it
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.sha,
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: commits.data[0].sha,
                          body: comment
                        });
                      }

    failure-notification:
        name: Failure Notification
        runs-on: ubuntu-latest
        if: failure()
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Comment on Failure
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = `## ‚ùå Workflow Failed

                      **üö® One or more jobs have failed**

                      **üîß Quick Fixes:**
                      1. **Format Issues**: Run \`terraform fmt terraform/\` locally
                      2. **Validation Issues**: Check syntax with \`terraform validate\`
                      3. **Resource Conflicts**: Update resource names or CIDR ranges
                      4. **AWS Limits**: Check for service limits or existing resources

                      **üõ†Ô∏è General Troubleshooting:**
                      - Check the logs above for specific error messages
                      - Verify AWS credentials and permissions
                      - Ensure resource naming doesn't conflict
                      - Review Terraform configuration syntax

                      **üîÑ Next Steps:**
                      1. Fix the issues identified above
                      2. Commit and push your changes
                      3. Monitor the new workflow run
                      4. Check the logs for any remaining issues`;

                      // Comment on the PR if it's a pull request
                      if (context.eventName === 'pull_request') {
                        await github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                        });
                      } else {
                        // Comment on the commit for direct pushes
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: context.sha,
                          body: comment
                        });
                      }

    cleanup:
        name: Cleanup (Manual)
        runs-on: ubuntu-latest
        if: github.event.inputs.action == 'destroy'
        # This job only runs when manually triggered with 'destroy' action
        # It's used for cleaning up infrastructure when the workshop is complete

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Terraform Destroy
              working-directory: terraform
              run: terraform destroy -auto-approve
