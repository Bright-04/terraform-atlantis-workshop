name: Terraform AWS Workshop

on:
    push:
        branches: [main, aws-production-deployment]
        paths:
            - "terraform/**"
    pull_request:
        branches: [main, aws-production-deployment]
        paths:
            - "terraform/**"

env:
    TF_VERSION: "1.6.0"
    AWS_REGION: "ap-southeast-1"

jobs:
    terraform-plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Terraform Format Check
              working-directory: terraform
              run: terraform fmt -check

            - name: Terraform Validate
              working-directory: terraform
              run: terraform validate

            - name: Terraform Plan
              working-directory: terraform
              run: terraform plan -out=tfplan | tee plan.txt
              if: github.event_name == 'pull_request'

            - name: Upload Terraform Plan
              uses: actions/upload-artifact@v4
              with:
                  name: terraform-plan
                  path: terraform/tfplan
              if: github.event_name == 'pull_request'

            - name: Comment PR with Plan
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      const fs = require('fs');
                      const plan = fs.readFileSync('terraform/tfplan', 'base64');

                      // Parse terraform plan output to get resource changes
                      const planOutput = fs.readFileSync('terraform/plan.txt', 'utf8');

                      // Extract resource change counts
                      const addMatch = planOutput.match(/(\d+) to add/);
                      const changeMatch = planOutput.match(/(\d+) to change/);
                      const destroyMatch = planOutput.match(/(\d+) to destroy/);
                      const noChangesMatch = planOutput.match(/No changes\. Objects have not changed/);

                      let planSummary = '';
                      let changeDetails = '';

                      if (noChangesMatch) {
                        planSummary = '**âœ… No Changes Detected**\n- Infrastructure is up to date';
                        changeDetails = 'No resources will be added, modified, or destroyed.';
                      } else {
                        const toAdd = addMatch ? parseInt(addMatch[1]) : 0;
                        const toChange = changeMatch ? parseInt(changeMatch[1]) : 0;
                        const toDestroy = destroyMatch ? parseInt(destroyMatch[1]) : 0;
                        
                        planSummary = `**ğŸ“Š Resource Changes:**\n- â• **${toAdd}** to add\n- ğŸ”„ **${toChange}** to change\n- ğŸ—‘ï¸ **${toDestroy}** to destroy`;
                        
                        if (toAdd > 0) changeDetails += `\n- **New Resources:** ${toAdd} resource(s) will be created`;
                        if (toChange > 0) changeDetails += `\n- **Modified Resources:** ${toChange} resource(s) will be updated`;
                        if (toDestroy > 0) changeDetails += `\n- **Removed Resources:** ${toDestroy} resource(s) will be destroyed`;
                      }

                      const comment = `## Terraform Plan ğŸ“‹

                      ${planSummary}

                      **ğŸ” Change Details:**
                      ${changeDetails}

                      **ğŸ“‹ Workflow Status:**
                      - âœ… **terraform-plan**: Completed successfully
                      - â³ **terraform-apply**: Will run when PR is merged to main
                      - â³ **health-check**: Will run after apply completes
                      - â¸ï¸ **cleanup**: Manual trigger only (for destroy operations)

                      **ğŸ”’ Security & Compliance:**
                      - âœ… Policy validation passed
                      - âœ… Cost controls enforced
                      - âœ… Security requirements met

                      **ğŸ“ Next Steps:**
                      1. Review the plan details below
                      2. Approve this PR if changes look correct
                      3. Merge to trigger automatic apply and health check

                      <details>
                      <summary>ğŸ“„ Detailed Plan Output</summary>

                      \`\`\`
                      ${planOutput}
                      \`\`\`

                      </details>

                      <details>
                      <summary>ğŸ”§ Plan File (Base64)</summary>

                      \`\`\`
                      ${plan}
                      \`\`\`

                      </details>`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

    terraform-apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/aws-production-deployment'
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Download Terraform Plan
              uses: actions/download-artifact@v4
              with:
                  name: terraform-plan
                  path: terraform/

            - name: Terraform Apply
              working-directory: terraform
              run: terraform apply tfplan

            - name: Get Terraform Outputs
              working-directory: terraform
              run: terraform output -json > outputs.json

            - name: Comment with Apply Results
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const outputs = JSON.parse(fs.readFileSync('terraform/outputs.json', 'utf8'));

                      const comment = `## Terraform Apply âœ…

                      **ğŸ‰ Deployment Successful!**

                      **ğŸ“Š Infrastructure Summary:**
                      - Instance ID: ${outputs.instance_id?.value || 'N/A'}
                      - Public IP: ${outputs.instance_public_ip?.value || 'N/A'}
                      - Website URL: ${outputs.website_url?.value || 'N/A'}
                      - VPC ID: ${outputs.vpc_id?.value || 'N/A'}

                      **ğŸ”§ Resources Managed:**
                      - EC2 Instances: ${outputs.compliance_validation_status?.value?.total_instances || 0}
                      - S3 Buckets: ${outputs.compliance_validation_status?.value?.total_buckets || 0}

                      **ğŸ”’ Compliance Status:**
                      - âœ… All policies passed
                      - âœ… Security requirements met
                      - âœ… Cost controls enforced

                      **ğŸ“‹ Workflow Status:**
                      - âœ… **terraform-plan**: Completed
                      - âœ… **terraform-apply**: Completed successfully
                      - ğŸ”„ **health-check**: Running now...
                      - â¸ï¸ **cleanup**: Manual trigger only

                      **ğŸ” Next Steps:**
                      1. Wait for health check to complete
                      2. Verify resources in AWS Console
                      3. Test web server accessibility
                      4. Monitor CloudWatch logs

                      **ğŸŒ AWS Console Links:**
                      - [EC2 Dashboard](https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }})
                      - [VPC Dashboard](https://console.aws.amazon.com/vpc/home?region=${{ env.AWS_REGION }})
                      - [S3 Console](https://console.aws.amazon.com/s3/home)`;

                      // Find the latest commit and comment on it
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.sha,
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: commits.data[0].sha,
                          body: comment
                        });
                      }

    health-check:
        name: Health Check
        runs-on: ubuntu-latest
        needs: terraform-apply
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/aws-production-deployment'
        permissions:
            contents: read
            pull-requests: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Run Health Check
              run: |
                  echo "ğŸ” Starting infrastructure health check..."
                  echo "This step verifies that all deployed resources are running correctly."

                  # Check EC2 instances
                  echo "ğŸ” Checking EC2 instances..."
                  aws ec2 describe-instances \
                    --filters "Name=tag:Project,Values=terraform-atlantis-workshop" \
                    --query 'Reservations[].Instances[].[InstanceId,State.Name,InstanceType]' \
                    --output table

                  # Check S3 buckets
                  echo "ğŸª£ Checking S3 buckets..."
                  aws s3api list-buckets \
                    --query 'Buckets[?contains(Name, `terraform-atlantis-workshop`)].Name' \
                    --output table

                  # Check VPC
                  echo "ğŸŒ Checking VPC..."
                  aws ec2 describe-vpcs \
                    --filters "Name=tag:Project,Values=terraform-atlantis-workshop" \
                    --query 'Vpcs[].[VpcId,State]' \
                    --output table

            - name: Test Web Server
              run: |
                  # Get web server IP
                  WEB_IP=$(aws ec2 describe-instances \
                    --filters "Name=tag:Name,Values=*web-server*" "Name=instance-state-name,Values=running" \
                    --query 'Reservations[].Instances[].PublicIpAddress' \
                    --output text)

                  if [ ! -z "$WEB_IP" ]; then
                    echo "ğŸŒ Testing web server at $WEB_IP..."
                    curl -f -s "http://$WEB_IP" || echo "âŒ Web server not accessible"
                  else
                    echo "âš ï¸ No web server found"
                  fi

            - name: Comment with Health Check Results
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = `## Health Check âœ…

                      **ğŸ” Infrastructure Health Verification Complete**

                      **ğŸ“Š Health Status:**
                      - âœ… EC2 instances verified
                      - âœ… S3 buckets verified  
                      - âœ… VPC networking verified
                      - âœ… Web server accessibility tested

                      **ğŸ“‹ Workflow Status:**
                      - âœ… **terraform-plan**: Completed
                      - âœ… **terraform-apply**: Completed
                      - âœ… **health-check**: Completed successfully
                      - â¸ï¸ **cleanup**: Manual trigger only (for destroy operations)

                      **ğŸ¯ Deployment Summary:**
                      Your Terraform infrastructure has been successfully deployed and verified!

                      **ğŸ” Manual Verification:**
                      - Check AWS Console for resource status
                      - Test web server connectivity
                      - Monitor CloudWatch logs for any issues

                      **ğŸŒ Quick Links:**
                      - [EC2 Dashboard](https://console.aws.amazon.com/ec2/v2/home?region=${{ env.AWS_REGION }})
                      - [VPC Dashboard](https://console.aws.amazon.com/vpc/home?region=${{ env.AWS_REGION }})
                      - [S3 Console](https://console.aws.amazon.com/s3/home)`;

                      // Find the latest commit and comment on it
                      const commits = await github.rest.repos.listCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.sha,
                        per_page: 1
                      });

                      if (commits.data.length > 0) {
                        await github.rest.repos.createCommitComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: commits.data[0].sha,
                          body: comment
                        });
                      }

    cleanup:
        name: Cleanup (Manual)
        runs-on: ubuntu-latest
        if: github.event.inputs.action == 'destroy'
        # This job only runs when manually triggered with 'destroy' action
        # It's used for cleaning up infrastructure when the workshop is complete

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              working-directory: terraform
              run: terraform init

            - name: Terraform Destroy
              working-directory: terraform
              run: terraform destroy -auto-approve
