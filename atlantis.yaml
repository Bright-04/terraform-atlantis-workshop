version: 3
projects:
  - name: terraform-atlantis-workshop
    dir: terraform
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "*.tfvars.json"]
      enabled: true
    apply_requirements: 
      - "approved"
      - "mergeable"
      - "undiverged"
    workflow: localstack-with-approval
    
workflows:
  localstack-with-approval:
    plan:
      steps:
        - init:
            extra_args: ["-upgrade"]
        - run: |
            echo "ğŸ” Pre-plan validation checks..."
            echo "ğŸ“ Validating Terraform configuration..."
            terraform validate
        - run: |
            echo "â³ Waiting for LocalStack to be ready..."
            until curl -s http://localstack:4566/health | grep -q "running"; do
              echo "   Still waiting for LocalStack..."
              sleep 5
            done
            echo "âœ… LocalStack is ready!"
        - plan:
            extra_args: ["-var-file=terraform.tfvars"]
        - run: |
            echo "ğŸ“Š Plan completed successfully!"
            echo "ğŸ”’ This plan requires approval before apply"
            echo "ğŸ“‹ To apply: Get approval, then comment 'atlantis apply'"
    apply:
      steps:
        - run: |
            echo "ğŸš€ Starting apply process..."
            echo "âœ… Approval requirements met"
            echo "ğŸ” Proceeding with infrastructure changes"
        - run: |
            echo "â³ Verifying LocalStack connectivity..."
            until curl -s http://localstack:4566/health | grep -q "running"; do
              echo "   Waiting for LocalStack..."
              sleep 5
            done
            echo "âœ… LocalStack is ready for apply!"
        - apply:
            extra_args: ["-var-file=terraform.tfvars"]
        - run: |
            echo "ğŸ‰ Apply completed successfully!"
            echo "ğŸ“ˆ Infrastructure changes have been applied"
            echo "ğŸ” Check the Atlantis UI for detailed logs"

# Global configuration
repo_locking: true
parallel_plan: true
parallel_apply: false
delete_source_branch_on_merge: false
allowed_regexp_prefixes: ["dev/", "feature/", "hotfix/"]
