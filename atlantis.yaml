version: 3
projects:
  - name: terraform-atlantis-workshop
    dir: terraform
    terraform_version: v1.6.0
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "*.tfvars.json"]
      enabled: true
    apply_requirements: 
      - "approved"
      - "mergeable"
      - "undiverged"
    workflow: localstack-with-approval
    
workflows:
  localstack-with-approval:
    plan:
      steps:
        - init:
            extra_args: ["-upgrade"]
        - run: |
            echo "🔍 Pre-plan validation checks..."
            echo "📝 Validating Terraform configuration..."
            terraform validate
        - run: |
            echo "⏳ Waiting for LocalStack to be ready..."
            until curl -s http://localstack:4566/health | grep -q "running"; do
              echo "   Still waiting for LocalStack..."
              sleep 5
            done
            echo "✅ LocalStack is ready!"
        - plan:
            extra_args: ["-var-file=terraform.tfvars"]
        - run: |
            echo "📊 Plan completed successfully!"
            echo "🔒 This plan requires approval before apply"
            echo "📋 To apply: Get approval, then comment 'atlantis apply'"
    apply:
      steps:
        - run: |
            echo "🚀 Starting apply process..."
            echo "✅ Approval requirements met"
            echo "🔐 Proceeding with infrastructure changes"
        - run: |
            echo "⏳ Verifying LocalStack connectivity..."
            until curl -s http://localstack:4566/health | grep -q "running"; do
              echo "   Waiting for LocalStack..."
              sleep 5
            done
            echo "✅ LocalStack is ready for apply!"
        - apply:
            extra_args: ["-var-file=terraform.tfvars"]
        - run: |
            echo "🎉 Apply completed successfully!"
            echo "📈 Infrastructure changes have been applied"
            echo "🔍 Check the Atlantis UI for detailed logs"

# Global configuration
repo_locking: true
parallel_plan: true
parallel_apply: false
delete_source_branch_on_merge: false
allowed_regexp_prefixes: ["dev/", "feature/", "hotfix/"]
