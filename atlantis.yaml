version: 3
projects:
    - name: terraform-atlantis-workshop
      dir: terraform
      workspace: default
      terraform_version: v1.6.0
      autoplan:
          when_modified: ["*.tf", "../.github/workflows/*.yml"]
          enabled: true
      apply_requirements: [approved, mergeable]
      workflow: custom
      custom_apply_workflow: aws-production
      custom_plan_workflow: aws-production

workflows:
    aws-production:
        plan:
            steps:
                - run: terraform init
                - run: terraform fmt -check -recursive
                - run: terraform validate
                - run: terraform plan -out=tfplan
                - run: terraform show tfplan
                - run: |
                    if [ $? -eq 0 ]; then
                      echo "## ✅ Terraform Plan Successful" >> $GITHUB_STEP_SUMMARY
                      echo "All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "## ❌ Terraform Plan Failed" >> $GITHUB_STEP_SUMMARY
                      echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
                      echo "Common issues:" >> $GITHUB_STEP_SUMMARY
                      echo "- Run 'terraform fmt' to fix formatting" >> $GITHUB_STEP_SUMMARY
                      echo "- Run 'terraform validate' to check syntax" >> $GITHUB_STEP_SUMMARY
                      exit 1
                    fi
        apply:
            steps:
                - run: terraform init
                - run: terraform apply tfplan
                - run: terraform output -json > outputs.json
                - run: |
                      echo "## Terraform Apply Results" >> $GITHUB_STEP_SUMMARY
                      echo "Infrastructure deployed successfully!" >> $GITHUB_STEP_SUMMARY
                      if [ -f outputs.json ]; then
                        echo "Outputs:" >> $GITHUB_STEP_SUMMARY
                        cat outputs.json >> $GITHUB_STEP_SUMMARY
                      fi

# Repository settings
repo_config:
    - id: /.*/
      branch: /.*/
      apply_requirements: [approved, mergeable]
      allowed_overrides: [apply_requirements, workflow]
      allow_custom_workflows: true
