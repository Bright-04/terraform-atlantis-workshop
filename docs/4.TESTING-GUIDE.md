# 4. Testing Guide - Terraform Atlantis Workshop

## 4.1 Overview

This guide provides comprehensive testing procedures for the Terraform Atlantis Workshop infrastructure, including compliance validation, GitOps workflows, and operational procedures.

## 4.2 🎯 Testing Strategy

### 4.2.1 Testing Pyramid

```
                    ┌─────────────────┐
                    │   Integration   │
                    │     Tests       │
                    └─────────────────┘
                           │
                    ┌─────────────────┐
                    │   Compliance    │
                    │   Validation    │
                    └─────────────────┘
                           │
                    ┌─────────────────┐
                    │   Unit Tests    │
                    │   (Terraform)   │
                    └─────────────────┘
```

### 4.2.2 Test Categories

1. **Unit Tests**: Terraform validation and syntax
2. **Compliance Tests**: Policy enforcement validation
3. **Integration Tests**: End-to-end infrastructure deployment
4. **GitOps Tests**: Atlantis workflow validation
5. **Operational Tests**: Health checks and monitoring

### 4.2.3 Environment Configuration for Testing

**AWS Testing Environment**:

```powershell
# Use AWS CLI configuration
aws configure
# Or set environment variables
$env:AWS_ACCESS_KEY_ID="your-access-key"
$env:AWS_SECRET_ACCESS_KEY="your-secret-key"
$env:AWS_DEFAULT_REGION="us-east-1"
```

**Atlantis Testing Environment**:

```powershell
$env:ATLANTIS_ALLOW_CUSTOM_WORKFLOWS="true"
$env:ATLANTIS_REQUIRE_APPROVAL="false"
$env:ATLANTIS_REQUIRE_MERGEABLE="false"
$env:ATLANTIS_ENABLE_POLICY_CHECKS="false"
```

## 4.3 🔧 Unit Testing

### 4.3.1 Terraform Validation

**Syntax Validation**:

```powershell
cd terraform
terraform validate
```

**Format Check**:

```powershell
terraform fmt -check
terraform fmt -diff
```

**Variable Validation**:

```powershell
# Test variable constraints
terraform plan -var="instance_type=invalid-type"  # Should fail
terraform plan -var="instance_type=t3.micro"      # Should pass
```

### 4.3.2 Configuration Testing

**Provider Configuration**:

```powershell
# Test AWS provider
terraform init
terraform plan
```

**Resource Configuration**:

```powershell
# Test resource definitions
terraform validate
terraform plan -target=aws_vpc.main
terraform plan -target=aws_instance.web
```

## 4.4 🛡️ Compliance Validation Testing

### 4.4.1 Policy Rule Testing

**Instance Type Restrictions**:

```powershell
# Test compliant instance types
terraform plan  # Should pass with t3.micro, t3.small, t3.medium

# Test violation (temporarily modify test-policy-violations.tf)
# Change instance_type to "m5.large"
terraform plan  # Should fail with violation message
```

**Required Tags Testing**:

```powershell
# Test missing tags (temporarily remove tags)
# Remove Environment, Project, CostCenter tags
terraform plan  # Should fail with tag violation

# Test compliant tags
# Restore all required tags
terraform plan  # Should pass
```

**S3 Bucket Naming Testing**:

```powershell
# Test naming violation (temporarily change bucket name)
# Change bucket name to "my-bucket"
terraform plan  # Should fail with naming violation

# Test compliant naming
# Restore terraform-atlantis-workshop-* naming
terraform plan  # Should pass
```

### 4.4.2 Compliance Test Scenarios

**Scenario 1: Expensive Instance Type**:

```terraform
# In test-policy-violations.tf
resource "aws_instance" "test_violation" {
  ami           = "ami-0abcdef1234567890"
  instance_type = "m5.large"  # VIOLATION: Expensive instance type
}
```

**Expected Result**:

```
❌ VIOLATION: Found expensive instance types. Only t3.micro, t3.small, t3.medium are permitted.
Current instances: policy_test=t3.small, test_violation=m5.large, web=t3.micro
```

**Scenario 2: Missing Required Tags**:

```terraform
resource "aws_instance" "test_violation" {
  ami           = "ami-0abcdef1234567890"
  instance_type = "t3.micro"

  tags = {
    Name = "test-instance"
    # Missing Environment, Project, CostCenter tags
  }
}
```

**Expected Result**:

```
❌ VIOLATION: EC2 instances missing required tags (Environment, Project, CostCenter).
```

**Scenario 3: S3 Bucket Naming Violation**:

```terraform
resource "aws_s3_bucket" "test_violation" {
  bucket = "wrong-naming-convention"  # VIOLATION: Wrong naming
}
```

**Expected Result**:

```
❌ VIOLATION: S3 buckets must follow naming convention: terraform-atlantis-workshop-*.
```

### 4.4.3 Automated Compliance Testing

**Test Script**:

```powershell
# Create test-compliance.ps1
Write-Host "Testing Compliance Validation..." -ForegroundColor Green

# Test 1: Valid configuration
Write-Host "Test 1: Valid configuration" -ForegroundColor Yellow
cd terraform
terraform plan
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Valid configuration test passed" -ForegroundColor Green
} else {
    Write-Host "❌ Valid configuration test failed" -ForegroundColor Red
}

# Test 2: Introduce violation
Write-Host "Test 2: Instance type violation" -ForegroundColor Yellow
# Temporarily modify test-policy-violations.tf
terraform plan
if ($LASTEXITCODE -ne 0) {
    Write-Host "✅ Violation detection test passed" -ForegroundColor Green
} else {
    Write-Host "❌ Violation detection test failed" -ForegroundColor Red
}

# Restore compliant configuration
git checkout -- test-policy-violations.tf
```

## 4.5 🔄 Integration Testing

### 4.5.1 End-to-End Deployment Testing

**AWS Deployment Test**:

```powershell
# Test complete AWS deployment
Write-Host "Testing AWS Deployment..." -ForegroundColor Green

# 1. Verify AWS credentials
aws sts get-caller-identity

# 2. Deploy infrastructure
cd terraform
.\deploy-aws.ps1

# 3. Verify resources
terraform output
aws ec2 describe-instances
aws s3 ls

Write-Host "✅ AWS deployment test completed" -ForegroundColor Green
```

**Resource Verification Test**:

```powershell
# Verify all resources are created correctly
Write-Host "Verifying Resources..." -ForegroundColor Green

# Check VPC
$vpc = aws ec2 describe-vpcs --query 'Vpcs[0].VpcId' --output text
Write-Host "VPC: $vpc" -ForegroundColor Cyan

# Check EC2 instances
$instances = aws ec2 describe-instances --query 'Reservations[].Instances[].InstanceId' --output text
Write-Host "EC2 Instances: $instances" -ForegroundColor Cyan

# Check S3 buckets
$buckets = aws s3 ls
Write-Host "S3 Buckets: $buckets" -ForegroundColor Cyan

Write-Host "✅ Resource verification completed" -ForegroundColor Green
```

### 4.5.2 Compliance Integration Test

**Full Compliance Workflow Test**:

```powershell
# Test complete compliance workflow
Write-Host "Testing Compliance Workflow..." -ForegroundColor Green

# 1. Test compliant deployment
terraform plan
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Compliant deployment test passed" -ForegroundColor Green
} else {
    Write-Host "❌ Compliant deployment test failed" -ForegroundColor Red
}

# 2. Test violation detection
# Introduce violation
Write-Host "Introducing violation for testing..." -ForegroundColor Yellow
terraform plan
if ($LASTEXITCODE -ne 0) {
    Write-Host "✅ Violation detection test passed" -ForegroundColor Green
} else {
    Write-Host "❌ Violation detection test failed" -ForegroundColor Red
}

# 3. Test violation resolution
Write-Host "Resolving violation..." -ForegroundColor Yellow
# Fix violation
terraform plan
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Violation resolution test passed" -ForegroundColor Green
} else {
    Write-Host "❌ Violation resolution test failed" -ForegroundColor Red
}
```

## 4.6 🚀 GitOps Testing

### 4.6.1 Atlantis Workflow Testing

**Local Atlantis Test**:

```powershell
# Test Atlantis locally
Write-Host "Testing Atlantis Workflow..." -ForegroundColor Green

# 1. Start Atlantis
docker-compose up atlantis -d
Start-Sleep -Seconds 10

# 2. Test Atlantis health
$atlantisHealth = Invoke-WebRequest -Uri "http://localhost:4141/health" -UseBasicParsing
if ($atlantisHealth.StatusCode -eq 200) {
    Write-Host "✅ Atlantis health check passed" -ForegroundColor Green
} else {
    Write-Host "❌ Atlantis health check failed" -ForegroundColor Red
}
```

**GitHub Integration Test**:

```powershell
# Test GitHub webhook (if configured)
Write-Host "Testing GitHub Integration..." -ForegroundColor Green

# Check webhook configuration
# This requires actual GitHub repository setup
Write-Host "⚠️  GitHub integration test requires repository setup" -ForegroundColor Yellow
```

### 4.6.2 Pull Request Testing

**Simulated PR Test**:

```powershell
# Simulate PR workflow
Write-Host "Simulating PR Workflow..." -ForegroundColor Green

# 1. Create test branch
git checkout -b test-compliance-validation

# 2. Make changes
# Edit terraform files

# 3. Test plan
cd terraform
terraform plan

# 4. Commit changes
git add .
git commit -m "Test compliance validation"

# 5. Cleanup
git checkout main
git branch -D test-compliance-validation

Write-Host "✅ PR workflow simulation completed" -ForegroundColor Green
```

## 4.7 📊 Operational Testing

### 4.7.1 Health Check Testing

**Service Health Tests**:

```powershell
# Test LocalStack health
Write-Host "Testing LocalStack Health..." -ForegroundColor Green
$localstackHealth = Invoke-WebRequest -Uri "http://localhost:4566/_localstack/health" -UseBasicParsing
if ($localstackHealth.StatusCode -eq 200) {
    Write-Host "✅ LocalStack health check passed" -ForegroundColor Green
} else {
    Write-Host "❌ LocalStack health check failed" -ForegroundColor Red
}

# Test Atlantis health
Write-Host "Testing Atlantis Health..." -ForegroundColor Green
$atlantisHealth = Invoke-WebRequest -Uri "http://localhost:4141/health" -UseBasicParsing
if ($atlantisHealth.StatusCode -eq 200) {
    Write-Host "✅ Atlantis health check passed" -ForegroundColor Green
} else {
    Write-Host "❌ Atlantis health check failed" -ForegroundColor Red
}
```

**Infrastructure Health Tests**:

```powershell
# Test Terraform state
Write-Host "Testing Terraform State..." -ForegroundColor Green
terraform show
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Terraform state check passed" -ForegroundColor Green
} else {
    Write-Host "❌ Terraform state check failed" -ForegroundColor Red
}

# Test compliance status
Write-Host "Testing Compliance Status..." -ForegroundColor Green
terraform output compliance_validation_status
if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ Compliance status check passed" -ForegroundColor Green
} else {
    Write-Host "❌ Compliance status check failed" -ForegroundColor Red
}
```

### 4.7.2 Performance Testing

**Deployment Performance**:

```powershell
# Test deployment time
Write-Host "Testing Deployment Performance..." -ForegroundColor Green
$startTime = Get-Date

cd terraform
terraform plan

$endTime = Get-Date
$duration = $endTime - $startTime
Write-Host "Deployment plan completed in $($duration.TotalSeconds) seconds" -ForegroundColor Cyan

if ($duration.TotalSeconds -lt 30) {
    Write-Host "✅ Deployment performance test passed" -ForegroundColor Green
} else {
    Write-Host "⚠️  Deployment performance test slow" -ForegroundColor Yellow
}
```

## 4.8 🧪 Test Automation

### 4.8.1 Automated Test Suite

**Complete Test Script**:

```powershell
# Create run-tests.ps1
Write-Host "Running Complete Test Suite..." -ForegroundColor Green

# Test categories
$tests = @(
    "Unit Tests",
    "Compliance Validation",
    "Integration Tests",
    "GitOps Tests",
    "Operational Tests"
)

foreach ($test in $tests) {
    Write-Host "Running $test..." -ForegroundColor Yellow

    switch ($test) {
        "Unit Tests" {
            cd terraform
            terraform validate
            terraform fmt -check
        }
        "Compliance Validation" {
            terraform plan
        }
        "Integration Tests" {
            # Run integration tests
        }
        "GitOps Tests" {
            # Run GitOps tests
        }
        "Operational Tests" {
            # Run operational tests
        }
    }

    if ($LASTEXITCODE -eq 0) {
        Write-Host "✅ $test passed" -ForegroundColor Green
    } else {
        Write-Host "❌ $test failed" -ForegroundColor Red
    }
}

Write-Host "Test suite completed!" -ForegroundColor Green
```

### 4.8.2 Continuous Testing

**GitHub Actions Test** (if using GitHub):

```yaml
# .github/workflows/test.yml
name: Test Infrastructure

on: [push, pull_request]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v1

            - name: Terraform Init
              run: |
                  cd terraform
                  terraform init

            - name: Terraform Validate
              run: |
                  cd terraform
                  terraform validate

            - name: Terraform Plan
              run: |
                  cd terraform
                  terraform plan
```

## 4.9 📋 Test Checklist

### 4.9.1 Pre-Deployment Tests

-   [ ] Terraform syntax validation
-   [ ] Variable validation
-   [ ] Provider configuration
-   [ ] Resource configuration
-   [ ] Compliance validation rules

### 4.9.2 Deployment Tests

-   [ ] AWS deployment
-   [ ] Resource creation verification
-   [ ] Compliance validation during deployment
-   [ ] Error handling and rollback

### 4.9.3 Post-Deployment Tests

-   [ ] Infrastructure health checks
-   [ ] Service availability
-   [ ] Compliance status verification
-   [ ] Performance metrics

### 4.9.4 GitOps Tests

-   [ ] Atlantis workflow
-   [ ] GitHub integration
-   [ ] Pull request processing
-   [ ] Compliance validation in PRs

## 4.10 🛠️ Troubleshooting Tests

### 4.10.1 Common Test Issues

**Terraform Validation Failures**:

```powershell
# Check syntax errors
terraform validate

# Check formatting
terraform fmt -check

# Check variable constraints
terraform plan -var="instance_type=invalid"
```

**Compliance Validation Issues**:

```powershell
# Check validation rules
cat terraform/compliance-validation.tf

# Test individual rules
terraform plan -target=null_resource.instance_type_validation
```

**AWS Issues**:

```powershell
# Check AWS credentials
aws sts get-caller-identity

# Check AWS infrastructure
.\monitoring\health-check-aws.ps1
```

### 4.10.2 Test Data Management

**Clean Test Environment**:

```powershell
# Clean up AWS infrastructure
cd terraform
.\destroy.ps1

# Verify cleanup
aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,State.Name]' --output table

# Redeploy fresh
.\deploy-aws.ps1
```

## 4.11 📚 Related Documentation

-   [1. Operational Procedures](OPERATIONS.md) - Day-to-day operations
-   [2. Compliance Validation](COMPLIANCE-VALIDATION.md) - Policy enforcement
-   [3. Deployment Guide](DEPLOYMENT-GUIDE.md) - Deployment procedures
-   [README.md](../readme.md) - Project overview

---

_This testing guide provides comprehensive procedures for validating infrastructure, compliance rules, and operational procedures to ensure reliable and secure deployments._
