# 5. AWS Production Deployment Guide

## 5.1 Overview

This guide covers the transition from LocalStack development environment to **real AWS production infrastructure**. The AWS production deployment provides enterprise-grade infrastructure with enhanced security, monitoring, and compliance features.

## 5.2 üéØ AWS Production Features

### 5.2.1 Enhanced Infrastructure Components

**Production-Grade Resources:**
- **Real EC2 Instances**: Amazon Linux 2 with Apache web server
- **Production VPC**: Multi-AZ networking with public/private subnets
- **Encrypted S3 Buckets**: Server-side encryption and versioning
- **CloudWatch Logging**: Centralized log management
- **IAM Roles & Policies**: Secure access management
- **Enhanced Security Groups**: Production-ready network security

### 5.2.2 Production Enhancements

**Security Features:**
- S3 bucket encryption (AES256)
- Public access blocking
- IAM roles for EC2 instances
- CloudWatch log retention policies
- Enhanced security group rules

**Monitoring & Observability:**
- CloudWatch log groups
- Application logging
- Infrastructure health monitoring
- Cost tracking and optimization

**Compliance & Governance:**
- Production tagging strategy
- Cost center allocation
- Backup policies
- Audit trail maintenance

## 5.3 üöÄ AWS Production Deployment

### 5.3.1 Prerequisites

**AWS Account Setup:**
```bash
# Install AWS CLI
# Configure AWS credentials
aws configure
```

**Required AWS Permissions:**
- EC2: Create instances, security groups, VPC resources
- S3: Create buckets, manage encryption and versioning
- IAM: Create roles and policies
- CloudWatch: Create log groups
- VPC: Create and manage networking resources

### 5.3.2 Quick AWS Deployment

1. **Switch to AWS Configuration:**
   ```powershell
   cd terraform
   .\deploy-aws.ps1
   ```

2. **Verify AWS Credentials:**
   ```powershell
   aws sts get-caller-identity
   aws configure get region
   ```

3. **Deploy Infrastructure:**
   ```powershell
   # The script will:
   # - Check AWS credentials
   # - Show cost estimates
   # - Backup current configuration
   # - Switch to AWS configuration
   # - Validate and deploy
   ```

### 5.3.3 Manual AWS Deployment

1. **Backup Current Configuration:**
   ```powershell
   cd terraform
   Copy-Item main.tf main-localstack.tf.backup
   ```

2. **Switch to AWS Configuration:**
   ```powershell
   Copy-Item main-aws.tf main.tf -Force
   ```

3. **Update Variables for Production:**
   ```hcl
   # terraform.tfvars
   environment = "production"
   instance_type = "t3.micro"
   region = "us-east-1"
   ```

4. **Deploy to AWS:**
   ```powershell
   terraform init
   terraform plan
   terraform apply
   ```

## 5.4 üîß AWS Configuration Details

### 5.4.1 Provider Configuration

**AWS Provider (main-aws.tf):**
```hcl
provider "aws" {
  region = var.region

  default_tags {
    tags = {
      Environment = var.environment
      Project     = var.project_name
      ManagedBy   = "Terraform"
      Provider    = "AWS"
      CostCenter  = "production"
    }
  }
}
```

**Key Differences from LocalStack:**
- No endpoint overrides
- Real AWS region configuration
- Production tagging strategy
- Enhanced security features

### 5.4.2 Production Resource Configuration

**EC2 Instance with Web Server:**
```hcl
resource "aws_instance" "web" {
  ami                    = data.aws_ami.amazon_linux.id
  instance_type          = var.instance_type
  subnet_id              = aws_subnet.public.id
  vpc_security_group_ids = [aws_security_group.web.id]
  
  user_data = base64encode(<<-EOF
    #!/bin/bash
    yum update -y
    yum install -y httpd
    systemctl start httpd
    systemctl enable httpd
    echo "<h1>Hello from ${var.project_name} on AWS!</h1>" > /var/www/html/index.html
    echo "<p>This instance was created with Terraform on AWS Production.</p>" >> /var/www/html/index.html
    echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
    echo "<p>Availability Zone: $(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)</p>" >> /var/www/html/index.html
  EOF
  )

  tags = {
    Name        = "${var.project_name}-web-server"
    Environment = var.environment
    CostCenter  = "production"
    Backup      = "daily"
  }
}
```

**S3 Bucket with Encryption:**
```hcl
resource "aws_s3_bucket" "workshop" {
  bucket = "${var.project_name}-${var.s3_bucket_suffix}"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "workshop" {
  bucket = aws_s3_bucket.workshop.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

resource "aws_s3_bucket_public_access_block" "workshop" {
  bucket = aws_s3_bucket.workshop.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

### 5.4.3 Monitoring and Logging

**CloudWatch Log Group:**
```hcl
resource "aws_cloudwatch_log_group" "application" {
  name              = "/aws/ec2/${var.project_name}"
  retention_in_days = 7

  tags = {
    Name        = "${var.project_name}-application-logs"
    Environment = var.environment
    CostCenter  = "production"
  }
}
```

**IAM Role for EC2:**
```hcl
resource "aws_iam_role" "ec2_role" {
  name = "${var.project_name}-ec2-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
}
```

## 5.5 üìä AWS Production Monitoring

### 5.5.1 Health Check Commands

**AWS-Specific Health Check:**
```powershell
.\monitoring\health-check-aws.ps1
```

**Manual AWS Resource Checks:**
```bash
# Check EC2 instances
aws ec2 describe-instances --query 'Reservations[].Instances[].[InstanceId,State.Name,InstanceType,PublicIpAddress]' --output table

# Check S3 buckets
aws s3api list-buckets --query 'Buckets[?contains(Name, `terraform-atlantis-workshop`)].Name' --output table

# Check VPC resources
aws ec2 describe-vpcs --query 'Vpcs[].[VpcId,CidrBlock,State]' --output table

# Check CloudWatch logs
aws logs describe-log-groups --query 'logGroups[?contains(logGroupName, `terraform-atlantis-workshop`)]'
```

### 5.5.2 Cost Monitoring

**Estimated Monthly Costs:**
- EC2 t3.micro (2 instances): $15-20
- S3 Storage (1GB): $0.023
- CloudWatch Logs: $0.50
- Data Transfer: $0.09/GB
- **Total Estimated: $20-30/month**

**Cost Optimization Tips:**
- Use t3.micro instances for development
- Enable S3 lifecycle policies
- Monitor CloudWatch log retention
- Use AWS Cost Explorer for tracking

## 5.6 üîÑ Environment Switching

### 5.6.1 LocalStack ‚Üí AWS

1. **Stop LocalStack:**
   ```powershell
   docker-compose down localstack
   ```

2. **Deploy to AWS:**
   ```powershell
   cd terraform
   .\deploy-aws.ps1
   ```

3. **Verify AWS Deployment:**
   ```powershell
   .\monitoring\health-check-aws.ps1
   ```

### 5.6.2 AWS ‚Üí LocalStack

1. **Destroy AWS Resources:**
   ```powershell
   cd terraform
   terraform destroy
   ```

2. **Switch Back to LocalStack:**
   ```powershell
   Copy-Item main-localstack.tf.backup main.tf -Force
   docker-compose up localstack -d
   terraform init
   terraform apply
   ```

## 5.7 üõ°Ô∏è Security Best Practices

### 5.7.1 Production Security Checklist

**Network Security:**
- [ ] Security groups with minimal required access
- [ ] VPC with public/private subnet separation
- [ ] Internet Gateway for public resources only
- [ ] Route tables properly configured

**Data Security:**
- [ ] S3 buckets encrypted at rest
- [ ] Public access blocked on S3 buckets
- [ ] IAM roles with least privilege
- [ ] CloudWatch logs with retention policies

**Access Management:**
- [ ] AWS credentials properly configured
- [ ] IAM policies for EC2 instances
- [ ] Security group rules reviewed
- [ ] Resource tagging for cost tracking

### 5.7.2 Compliance Validation

**Production Compliance Rules:**
- Instance type restrictions (t3.micro, t3.small, t3.medium)
- Required tags (Environment, Project, CostCenter)
- S3 bucket naming conventions
- Encryption requirements
- Backup policies

## 5.8 üîß Troubleshooting AWS Deployment

### 5.8.1 Common AWS Issues

**Credential Issues:**
```bash
# Check AWS credentials
aws sts get-caller-identity

# Configure credentials
aws configure

# Set environment variables
export AWS_ACCESS_KEY_ID="your-key"
export AWS_SECRET_ACCESS_KEY="your-secret"
export AWS_DEFAULT_REGION="us-east-1"
```

**Permission Issues:**
```bash
# Check IAM permissions
aws iam get-user
aws iam list-attached-user-policies --user-name your-username

# Common required permissions:
# - EC2FullAccess
# - S3FullAccess
# - IAMFullAccess
# - CloudWatchLogsFullAccess
```

**Resource Conflicts:**
```bash
# Check for existing resources
aws ec2 describe-instances --filters "Name=tag:Project,Values=terraform-atlantis-workshop"
aws s3api list-buckets --query 'Buckets[?contains(Name, `terraform-atlantis-workshop`)]'
```

### 5.8.2 Emergency Procedures

**Complete AWS Cleanup:**
```powershell
cd terraform
terraform destroy -auto-approve
```

**State Recovery:**
```powershell
# If state is corrupted
terraform init
terraform import aws_vpc.main vpc-xxxxxxxxx
terraform import aws_instance.web i-xxxxxxxxx
```

## 5.9 üìà Production Scaling

### 5.9.1 Scaling Considerations

**Horizontal Scaling:**
- Add more EC2 instances
- Use Auto Scaling Groups
- Implement load balancing
- Database scaling strategies

**Vertical Scaling:**
- Upgrade instance types
- Increase storage capacity
- Optimize application performance
- Monitor resource utilization

### 5.9.2 High Availability

**Multi-AZ Deployment:**
- Deploy across multiple availability zones
- Use Auto Scaling Groups
- Implement health checks
- Set up monitoring and alerting

## 5.10 üìö Related Documentation

- [1. Operational Procedures](OPERATIONS.md) - Day-to-day operations
- [2. Compliance Validation](COMPLIANCE-VALIDATION.md) - Policy enforcement
- [3. Deployment Guide](DEPLOYMENT-GUIDE.md) - General deployment procedures
- [4. Testing Guide](TESTING-GUIDE.md) - Testing procedures
- [README.md](../readme.md) - Project overview

## 5.11 üéØ AWS Production Checklist

### 5.11.1 Pre-Deployment
- [ ] AWS account configured
- [ ] AWS CLI installed and configured
- [ ] Required permissions verified
- [ ] Cost estimates reviewed
- [ ] Backup strategy planned

### 5.11.2 Deployment
- [ ] LocalStack configuration backed up
- [ ] AWS configuration deployed
- [ ] All resources created successfully
- [ ] Security groups configured
- [ ] Monitoring enabled

### 5.11.3 Post-Deployment
- [ ] Health checks passed
- [ ] Web server accessible
- [ ] S3 buckets encrypted
- [ ] CloudWatch logs working
- [ ] Compliance validation active
- [ ] Cost monitoring configured

---

_This AWS production guide provides comprehensive procedures for deploying and managing real AWS infrastructure with enterprise-grade security, monitoring, and compliance features._
