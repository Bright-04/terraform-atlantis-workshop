# 3. Deployment Guide - Terraform Atlantis Workshop

## 3.1 Overview

This guide covers deployment procedures for the Terraform Atlantis Workshop infrastructure, focusing on AWS production deployment.

## 3.2 🎯 Current Status

### 3.2.1 ✅ **Active Environment**: AWS Production

-   **Status**: Fully deployed and operational
-   **Infrastructure**: Real AWS resources (VPC, EC2, S3, etc.)
-   **Resources**: VPC, EC2 instances, S3 buckets, security groups
-   **Compliance**: All resources pass validation

### 3.2.2 🔧 **Environment Configuration**

**AWS Environment Variables**:

```powershell
# Use AWS CLI configuration
aws configure
# Or set environment variables directly
$env:AWS_ACCESS_KEY_ID="your-access-key"
$env:AWS_SECRET_ACCESS_KEY="your-secret-key"
$env:AWS_DEFAULT_REGION="us-east-1"
```

**Atlantis Environment Variables**:

```powershell
$env:ATLANTIS_ALLOW_CUSTOM_WORKFLOWS="true"
$env:ATLANTIS_REQUIRE_APPROVAL="false"
$env:ATLANTIS_REQUIRE_MERGEABLE="false"
$env:ATLANTIS_ENABLE_POLICY_CHECKS="false"
```

## 3.3 🚀 AWS Production Deployment

### 3.3.1 Prerequisites

-   AWS CLI installed and configured
-   AWS account with appropriate permissions
-   PowerShell (Windows) or equivalent shell
-   Git for version control

### 3.3.2 Quick Deployment

1. **Configure AWS Credentials**:

    ```powershell
    # Configure AWS CLI
    aws configure
    ```

2. **Deploy Infrastructure**:

    ```powershell
    cd terraform
    .\deploy-aws.ps1
    ```

3. **Verify Deployment**:

    ```powershell
    # Check Terraform outputs
    terraform output

    # Check AWS resources
    aws ec2 describe-instances
    aws s3 ls
    ```

### 3.3.3 Detailed AWS Setup

1. **Environment Configuration**:

    ```powershell
    # Verify AWS credentials
    aws sts get-caller-identity
    aws configure get region
    ```

2. **Initialize Terraform**:

    ```powershell
    cd terraform
    terraform init
    ```

3. **Plan Deployment**:

    ```powershell
    terraform plan
    ```

4. **Apply Configuration**:
    ```powershell
    terraform apply -auto-approve
    ```

### 3.3.4 AWS Resource Verification

**Check EC2 Instances**:

```powershell
aws ec2 describe-instances \
  --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,Tags[?Key==`Name`].Value|[0]]' \
  --output table
```

**Check S3 Buckets**:

```powershell
aws s3 ls
aws s3api list-buckets
```

**Check VPC and Networking**:

```powershell
aws ec2 describe-vpcs
aws ec2 describe-subnets
aws ec2 describe-security-groups
```

## 3.4 🎯 GitOps Deployment with Atlantis

### 3.4.1 Prerequisites

-   GitHub repository configured
-   Atlantis running and accessible
-   GitHub webhook configured

### 3.4.2 GitOps Workflow

1. **Create Feature Branch**:

    ```bash
    git checkout -b feature/new-resource
    ```

2. **Make Infrastructure Changes**:

    ```terraform
    # Edit Terraform files
    # Add new resources or modify existing ones
    ```

3. **Test Locally**:

    ```powershell
    cd terraform
    terraform plan
    ```

4. **Commit and Push**:

    ```bash
    git add .
    git commit -m "Add new infrastructure resource"
    git push origin feature/new-resource
    ```

5. **Create Pull Request**:

    - Go to GitHub repository
    - Create pull request from feature branch
    - Add description of changes

6. **Trigger Atlantis Plan**:

    ```bash
    # Comment in PR:
    atlantis plan -p terraform-atlantis-workshop
    ```

7. **Review Plan Output**:

    - Check for compliance violations
    - Review resource changes
    - Verify cost implications

8. **Apply Changes** (after approval):
    ```bash
    # Comment in PR:
    atlantis apply -p terraform-atlantis-workshop
    ```

### 3.4.3 Compliance Validation in GitOps

**Automatic Validation**:

-   Atlantis automatically runs compliance checks
-   Violations are detected during plan phase
-   Clear error messages in PR comments

**Example Violation Response**:

```
❌ VIOLATION: Found expensive instance types. Only t3.micro, t3.small, t3.medium are permitted.
Current instances: policy_test=t3.small, test_violation=m5.large, web=t3.micro
```

**Fixing Violations**:

1. Update Terraform configuration
2. Commit and push changes
3. Re-run `atlantis plan`
4. Verify violations are resolved

## 3.5 🔧 Configuration Management

### 3.5.1 Environment Variables

**AWS Environment**:

```powershell
# Use AWS CLI configuration
aws configure
```

### 3.5.2 Terraform Variables

**Default Configuration** (`terraform.tfvars`):

```hcl
environment = "workshop"
project     = "terraform-atlantis-workshop"
region      = "us-east-1"
instance_type = "t3.micro"
vpc_cidr    = "10.0.0.0/16"
```

**Environment-Specific Overrides**:

```hcl
# terraform.tfvars.prod
environment = "production"
instance_type = "t3.small"
```

### 3.5.3 Provider Configuration

**AWS Provider**:

```hcl
provider "aws" {
  region = var.region
}
```

## 3.6 📊 Deployment Verification

### 3.6.1 Health Checks

**Terraform State**:

```powershell
terraform show
terraform output
```

**Resource Status**:

```powershell
# AWS
aws ec2 describe-instances
```

### 3.6.2 Compliance Validation

**Check Compliance Status**:

```powershell
terraform output compliance_validation_status
```

**Test Validation Rules**:

```powershell
# Introduce violation for testing
# Edit terraform/test-policy-violations.tf
terraform plan  # Should fail with violation message
```

## 3.7 🛠️ Troubleshooting

### 3.7.1 Common Deployment Issues

**AWS Issues**:

```powershell
# Credential errors
aws configure
aws sts get-caller-identity

# Permission errors
# Check IAM policies and roles
```

### 3.7.2 Emergency Procedures

**Complete Reset**:

```powershell
# Stop all services
docker-compose down

# Clear data
docker volume rm terraform-atlantis-workshop-2_localstack-data 2>$null

# Restart fresh
docker-compose up -d
cd terraform
.\deploy.ps1
```

**State Recovery**:

```powershell
# Backup current state
cp terraform.tfstate terraform.tfstate.backup

# Import existing resources
terraform import aws_vpc.main vpc-xxxxxxxxx
terraform import aws_instance.web i-xxxxxxxxx
```

## 3.8 📚 Related Documentation

-   [1. Operational Procedures](OPERATIONS.md) - Day-to-day operations
-   [2. Compliance Validation](COMPLIANCE-VALIDATION.md) - Policy enforcement
-   [README.md](../readme.md) - Project overview
-   [Workshop Info](../workshop_info.md) - Workshop requirements

---

_This deployment guide provides comprehensive procedures for deploying infrastructure to both LocalStack and AWS environments with proper validation and compliance checks._
