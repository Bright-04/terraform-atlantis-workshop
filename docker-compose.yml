services:
    localstack:
        container_name: localstack_workshop
        image: localstack/localstack:latest
        ports:
            - "4566:4566" # LocalStack Gateway
            - "4510-4559:4510-4559" # External services port range
        environment:
            - SERVICES=ec2,s3,rds,iam,cloudwatch,logs,sts,lambda,apigateway
            - DEBUG=1
            - PERSISTENCE=0
            - LAMBDA_EXECUTOR=local
            - AWS_DEFAULT_REGION=us-east-1
            - AWS_ACCESS_KEY_ID=test
            - AWS_SECRET_ACCESS_KEY=test
        networks:
            - localstack-network

    atlantis:
        container_name: atlantis_workshop
        build:
            context: .
            dockerfile: Dockerfile.atlantis
        ports:
            - "4141:4141"
        env_file:
            - .env
        environment:
            # AWS/LocalStack Configuration - Override for container networking
            - AWS_DEFAULT_REGION=us-east-1
            - AWS_ACCESS_KEY_ID=test
            - AWS_SECRET_ACCESS_KEY=test
            - AWS_ENDPOINT_URL_EC2=http://localstack:4566
            - AWS_ENDPOINT_URL_S3=http://localstack:4566
            - AWS_ENDPOINT_URL_IAM=http://localstack:4566
            - AWS_ENDPOINT_URL_STS=http://localstack:4566
            # Atlantis Configuration
            - ATLANTIS_ALLOWED_OVERRIDES=workflow,apply_requirements,delete_source_branch_on_merge
            - ATLANTIS_ENABLE_POLICY_CHECKS=true
            - ATLANTIS_ALLOW_CUSTOM_WORKFLOWS=true
            - ATLANTIS_REQUIRE_APPROVAL=true
            - ATLANTIS_REQUIRE_MERGEABLE=true
            - DEFAULT_CONFTEST_VERSION=0.46.0
        volumes:
            - ./atlantis:/atlantis
            - ./terraform:/terraform
            - ./atlantis.yaml:/atlantis.yaml
            - ./policies:/policies
        depends_on:
            - localstack
        networks:
            - localstack-network

networks:
    localstack-network:
        driver: bridge
